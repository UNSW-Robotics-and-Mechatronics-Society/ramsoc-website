# Events API Endpoint Documentation

This documentation describes the Events API endpoint, which serves as a proxy to fetch event data from the Facebook Graph API while providing enhanced error handling and response normalization.

## Overview

The endpoint provides a paginated list of events associated with a Facebook page. It runs on the Edge runtime for optimal performance and implements cursor-based pagination for efficient data retrieval.

## Endpoint Details

- **URL**: `/api/events`
- **Method**: `GET`
- **Runtime**: Edge
- **Response Format**: JSON

### Query Parameters

The endpoint accepts a single optional query parameter:

`cursor` (optional): A pagination token used to fetch the next set of results. This value should be obtained from the previous response's `paging.cursors.after` field.

Example: `/api/events?cursor=MTAxNTExOTQ1MjAwNzI5NDE`

### Response Structure

The endpoint returns a JSON object with the following structure:

```typescript
{
  data: Array<{
    cover?: {
      offset_x: number; // Horizontal offset for cover image
      offset_y: number; // Vertical offset for cover image
      source: string; // URL to the cover image
    };
    name: string; // Event name
    description: string; // Event description
    start_time: string; // Event start time (ISO format)
    end_time: string; // Event end time (ISO format)
    id: number; // Event ID
    place?: {
      name: string; // Venue name
    };
  }>;
  paging: {
    cursors: {
      after: string; // Token for next page
      before: string; // Token for previous page
    }
  }
}
```

### Error Responses

The endpoint implements comprehensive error handling with the following status codes:

| Status Code | Description           | Cause                                                |
| ----------- | --------------------- | ---------------------------------------------------- |
| 200         | Success               | Request completed successfully                       |
| 400         | Invalid Cursor        | The provided pagination cursor is invalid or expired |
| 503         | Service Unavailable   | The Facebook API access token is invalid or expired  |
| 500         | Internal Server Error | Unexpected errors or network issues                  |

## Implementation Notes

### Facebook Graph API Integration

The endpoint proxies requests to the Facebook Graph API v21.0, specifically targeting the `/me/events` endpoint. It includes the following fields in the request:

- cover
- description
- end_time
- start_time
- place
- name
- id

The request is limited to 25 events per page to optimize for performance and bandwidth.

### Security Considerations

1. **Environment Variables**: The endpoint uses `META_API_PAGE_ACCESS_TOKEN` from environment variables, ensuring secure token management.

2. **Error Masking**: Internal errors are masked with generic error messages to prevent information leakage.

3. **Edge Runtime**: By running on the Edge runtime, the endpoint benefits from:
   - Reduced latency through geographic distribution
   - Automatic scaling
   - Enhanced security through isolation

### Code Example

Here's how to use the endpoint in a frontend application:

```typescript
async function fetchEvents(cursor?: string) {
  const url = `/api/events${cursor ? `?cursor=${cursor}` : ""}`;
  const response = await fetch(url);

  if (!response.ok) {
    switch (response.status) {
      case 400:
        throw new Error("Invalid pagination cursor");
      case 503:
        throw new Error("Service temporarily unavailable");
      default:
        throw new Error("Failed to fetch events");
    }
  }

  return await response.json();
}

// Usage example:
try {
  // Initial fetch
  const firstPage = await fetchEvents();

  // Fetch next page using cursor
  const nextPage = await fetchEvents(firstPage.paging.cursors.after);
} catch (error) {
  console.error("Error fetching events:", error);
}
```

## Error Handling Strategy

The endpoint implements a sophisticated error handling strategy that processes different types of errors from the Facebook Graph API:

1. **Network Errors**: If the request fails before receiving a response, a generic 500 error is returned.

2. **Authentication Errors**: Invalid token errors are detected by checking the `www-authenticate` header, returning a 503 status to indicate a service issue.

3. **Pagination Errors**: Invalid cursor errors are caught and translated to a 400 status with a clear error message.

This layered approach ensures that clients receive appropriate error responses while maintaining security through error message abstraction.

## Best Practices

When using this endpoint, consider the following best practices:

1. **Implement Retry Logic**: For 503 errors, implement an exponential backoff retry strategy.

2. **Cache Responses**: Consider caching successful responses on the client side to reduce API calls.

3. **Handle Rate Limits**: While the endpoint doesn't directly implement rate limiting, be mindful of Facebook's API limits.

4. **Monitor Errors**: Track 503 errors as they might indicate an expired access token that needs renewal.

## Rate Limiting

While this endpoint doesn't implement rate limiting directly, it's subject to Facebook's Graph API rate limits. Implement appropriate client-side throttling to avoid hitting these limits.

## Performance Considerations

1. The Edge runtime provides optimal performance through:

   - Reduced latency with geographic distribution
   - Efficient resource utilization
   - Automatic scaling

2. The 25-event page size balances between:
   - Minimizing network payload size
   - Reducing the number of required requests
   - Maintaining responsive user interfaces

## Future Improvements

Consider implementing:

1. Response caching at the edge
2. Request throttling
3. Expanded error reporting
4. Result filtering capabilities
